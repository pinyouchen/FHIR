<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini FHIR UI</title>
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --ink:#111827; --bg:#fafafa; --accent:#2563eb; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif; padding: 24px; max-width: 1200px; margin: auto; background: var(--bg); color: var(--ink);}
    h1 { margin: 0 0 8px 0 }
    a { color:#2563eb; text-decoration:none }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px }
    .card { border: 1px solid var(--border); border-radius: 12px; padding:16px; margin: 16px 0; background:white; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
    label { display:block; font-size: 14px; color:#374151; margin-top:8px }
    input, select { width: 100%; padding:8px; border:1px solid #d1d5db; border-radius:8px; margin-top:4px; background:white }
    button { margin-top:12px; padding:10px 14px; border-radius:10px; border:1px solid var(--ink); background:var(--ink); color:white; cursor:pointer; transition:.2s }
    button:hover { filter: brightness(0.95) }
    button.secondary { background:white; color:var(--ink) }
    button.danger { background:#991b1b; border-color:#991b1b }
    button:disabled { opacity:.6; cursor:not-allowed }
    .muted { color:var(--muted); font-size:13px }
    .stack { display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    table { width:100%; border-collapse: collapse; border-radius: 10px; overflow: hidden; border:1px solid var(--border); background:white }
    th, td { text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:14px }
    tr:hover { background:#f8fafc }
    .id { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#475569 }
    pre.json { background:#0b1020; color:#e5e7eb; padding:12px; border-radius:8px; overflow:auto; font-size:12px }
    .two { display:grid; grid-template-columns: 1.4fr 1fr; gap:16px }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#312e81; font-size:12px; border:1px solid #c7d2fe }
    .toolbar { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:8px }
    .right { text-align:right }
    .controls { display:flex; gap:8px; align-items:center }

    /* é¸å–é«˜äº®ã€loadingã€ç©ºç‹€æ…‹ã€toast */
    .row-selected { background:#eef2ff !important }
    .loading { opacity:.6; pointer-events:none }
    .empty { padding:16px; color:var(--muted); font-style:italic }
    .toast {
      position: fixed; right: 20px; bottom: 20px; background:#111827; color:white;
      padding:10px 14px; border-radius:10px; box-shadow:0 4px 14px rgba(0,0,0,.2);
      opacity:0; transform: translateY(8px); transition:.25s; z-index:9999;
    }
    .toast.show { opacity:1; transform: translateY(0) }

    /* === Results æª”æ¡ˆæ¸…å–®æ¨£å¼ï¼ˆç¾åŒ–ï¼‰ === */
    .files { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:14px }
    .file { border:1px solid var(--border); border-radius:12px; padding:12px; background:white; display:flex; gap:12px; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,.04); transition:.18s }
    .file:hover { transform: translateY(-2px); box-shadow:0 6px 16px rgba(0,0,0,.07); }
    .file .thumb { width:60px; height:60px; border-radius:10px; border:1px solid var(--border); object-fit:cover; background:#f1f5f9; display:grid; place-items:center; font-size:26px }
    .file .meta { min-width:0 }
    .file .name { font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .file .path { color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .file .actions { margin-left:auto; display:flex; gap:8px }
    .file .actions a, .file .actions button { font-size:12px; padding:7px 10px; border-radius:8px; border:1px solid var(--border); background:white; color:var(--ink); cursor:pointer }
    .file .actions a:hover, .file .actions button:hover { background:#f8fafc }
    .row-compact { display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .select-run { min-width:280px }

    /* é è¦½ Overlay */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:9998; }
    .overlay.show { display:flex }
    .overlay img { max-width:90vw; max-height:90vh; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.4); }
    @media (max-width:900px) { .files { grid-template-columns: repeat(2, minmax(0,1fr)); } }
    @media (max-width:640px) { .files { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>Mini FHIR UI</h1>
  <p class="muted">è¡¨å–® + æ¸…å–®æ¸¬è©¦ <code>/Patient</code>ã€<code>/Observation</code>ã€‚API æ–‡ä»¶ï¼š<a href="/docs" target="_blank">/docs</a> | åŒ¯å‡ºï¼š<a href="/export/patients.csv">patients.csv</a></p>

  <!-- Create / Update Patient -->
  <div class="two">
    <div class="card" aria-live="polite">
      <h2>Patientï¼ˆå»ºç«‹æˆ–æ›´æ–°ï¼‰</h2>
      <div class="row">
        <div>
          <label for="p-family">Family</label>
          <input id="p-family" placeholder="ä¾‹å¦‚ï¼šChen" />
        </div>
        <div>
          <label for="p-given">Givenï¼ˆå¯æ”¾ä¸€å€‹ï¼‰</label>
          <input id="p-given" placeholder="ä¾‹å¦‚ï¼šPin-Yu" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="p-gender">Gender</label>
          <select id="p-gender">
            <option value="">ï¼ˆä¸å¡«ï¼‰</option>
            <option>male</option>
            <option>female</option>
            <option>other</option>
            <option>unknown</option>
          </select>
        </div>
        <div>
          <label for="p-birth">BirthDate</label>
          <input id="p-birth" type="date" />
        </div>
      </div>
      <div class="stack">
        <button id="btn-create-p">å»ºç«‹ Patient</button>
        <button id="btn-update-p" class="secondary" disabled>æ›´æ–°é¸å–çš„ Patient</button>
        <button id="btn-delete-p" class="danger" disabled>åˆªé™¤é¸å–çš„ Patient</button>
        <button id="btn-refresh" class="secondary">é‡æ–°æ•´ç†æ¸…å–®</button>
      </div>
      <div class="muted">æç¤ºï¼šé»ä¸‹æ–¹è¡¨æ ¼ä¸€åˆ—å³å¯é¸å–ç—…äººï¼Œæ¬„ä½æœƒå¸¶å…¥ä»¥ä¾¿æ›´æ–°ã€‚</div>
      <pre id="p-result" class="json" aria-live="polite"></pre>
    </div>

    <!-- Create / Update Observation -->
    <div class="card" aria-live="polite">
      <h2>Observationï¼ˆå»ºç«‹æˆ–æ›´æ–°ï¼‰</h2>
      <div class="row">
        <div>
          <label for="o-subject">Subjectï¼ˆé¸æ“‡ Patientï¼‰</label>
          <select id="o-subject"></select>
        </div>
        <div>
          <label for="o-status">Status</label>
          <select id="o-status">
            <option>final</option>
            <option>registered</option>
            <option>preliminary</option>
            <option>amended</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="o-code">Code Text</label>
          <input id="o-code" placeholder="ä¾‹å¦‚ï¼šBody Temperature" />
        </div>
        <div>
          <label for="o-time">EffectiveDateTime</label>
          <input id="o-time" type="datetime-local" />
        </div>
      </div>
      <div class="row">
        <div>
          <label for="o-value">Value</label>
          <input id="o-value" type="number" step="any" placeholder="ä¾‹å¦‚ï¼š36.7" />
        </div>
        <div>
          <label for="o-unit">Unit</label>
          <input id="o-unit" placeholder="ä¾‹å¦‚ï¼šÂ°C æˆ– mg/dL" />
        </div>
      </div>
      <div class="stack">
        <button id="btn-create-o">å»ºç«‹ Observation</button>
        <button id="btn-update-o" class="secondary" disabled>æ›´æ–°é¸å–çš„ Observation</button>
        <button id="btn-delete-o" class="danger" disabled>åˆªé™¤é¸å–çš„ Observation</button>
      </div>
      <pre id="o-result" class="json" aria-live="polite"></pre>
    </div>
  </div>

  <!-- Patients table -->
  <div class="card" aria-live="polite">
    <div class="toolbar">
      <h2>ç—…äººæ¸…å–®</h2>
      <div class="stack">
        <input id="q-name" placeholder="å§“åé—œéµå­—ï¼ˆä¾‹å¦‚ chenï¼‰" aria-label="æœå°‹å§“åé—œéµå­—" />
        <button id="btn-search-p" class="secondary">æœå°‹</button>
      </div>
    </div>
    <table id="patients">
      <thead>
        <tr>
          <th>å§“å</th>
          <th>æ€§åˆ¥</th>
          <th>ç”Ÿæ—¥</th>
          <th class="id">ID</th>
          <th class="right">æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p class="muted">é»ä¸€åˆ—æœƒé¸å–ç—…äººä¸¦è¼‰å…¥ Observationsã€‚</p>
  </div>

  <!-- Observations table with paging/sort -->
  <div class="card" aria-live="polite">
    <div class="toolbar">
      <h2>Observationsï¼ˆ<span id="sel-name">æœªé¸æ“‡</span>ï¼‰</h2>
      <div class="controls">
        <label for="o-sort">æ’åº</label>
        <select id="o-sort" aria-label="Observations æ’åº">
          <option value="-effectiveDateTime">æœ€æ–°æ™‚é–“å„ªå…ˆ</option>
          <option value="effectiveDateTime">æœ€èˆŠæ™‚é–“å„ªå…ˆ</option>
          <option value="status">Status â†‘</option>
          <option value="-status">Status â†“</option>
          <option value="code">Code â†‘</option>
          <option value="-code">Code â†“</option>
        </select>
        <label for="o-count">æ¯é </label>
        <select id="o-count" aria-label="æ¯é é¡¯ç¤ºç­†æ•¸">
          <option>5</option>
          <option selected>10</option>
          <option>20</option>
        </select>
        <button id="o-prev" class="secondary">ä¸Šä¸€é </button>
        <span id="o-page" class="pill" aria-live="polite">1</span>
        <button id="o-next" class="secondary">ä¸‹ä¸€é </button>
      </div>
    </div>
    <span id="sel-id" class="pill" aria-live="polite"></span>
    <table id="obstable">
      <thead>
        <tr>
          <th>Status</th>
          <th>Code</th>
          <th>Value</th>
          <th>Time</th>
          <th class="id">ID</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- åˆ†æè¼¸å‡º Resultsï¼ˆç¾åŒ–ç‰ˆï¼‰ -->
  <div class="card" aria-live="polite">
    <div class="toolbar">
      <h2>åˆ†æè¼¸å‡ºï¼ˆResultsï¼‰</h2>
      <div class="row-compact">
        <label for="runs-select">é¸æ“‡ Run</label>
        <select id="runs-select" class="select-run"></select>
        <button id="runs-refresh" class="secondary">é‡æ–°æ•´ç†</button>
        <span id="runs-count" class="pill">0 æª”</span>
      </div>
    </div>
    <div id="runs-note" class="muted" style="margin-bottom:8px;">è³‡æ–™ä¾†è‡ª <code>/api/list-runs</code>ã€‚PNG æœƒé¡¯ç¤ºç¸®åœ–ï¼ˆå¯é è¦½ï¼‰ï¼›XLSX/CSV å¯ç›´æ¥ä¸‹è¼‰ã€‚</div>
    <div id="files" class="files" role="list"></div>
  </div>

  <!-- JSON viewer -->
  <div class="card" aria-live="polite">
    <h2>Raw JSONï¼ˆæœ€è¿‘ä¸€æ¬¡æ“ä½œï¼‰</h2>
    <pre id="last-json" class="json"></pre>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- é è¦½ Overlay -->
  <div id="overlay" class="overlay" aria-hidden="true">
    <img id="overlay-img" alt="preview" />
  </div>

<script>
/* -------------------- åŸºç¤ API èˆ‡å·¥å…· -------------------- */
const api = {
  get: (url) => fetch(url).then(r => r.json()),
  post: (url, data) => fetch(url, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(data) }).then(r => r.json()),
  put: (url, data) => fetch(url, { method:"PUT", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(data) }).then(r => r.json()),
  del: (url) => fetch(url, { method:"DELETE" }).then(r => (r.status===204 ? {} : r.json()))
};
const el = (id) => document.getElementById(id);
const J = (obj) => JSON.stringify(obj, null, 2);
const setJSON = (id, data) => el(id).textContent = J(data || {});

/* UI helpers */
function setBusy(node, busy=true){
  if(!node) return;
  node.classList.toggle('loading', busy);
  node.setAttribute('aria-busy', busy ? 'true' : 'false');
  if (node.tagName === 'BUTTON') node.disabled = !!busy;
}
function toast(msg, ok=true){
  const t = el('toast');
  t.textContent = msg;
  t.style.background = ok ? '#111827' : '#991b1b';
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 2200);
}
async function safe(fn, {target} = {}){
  try { if(target) setBusy(target,true); return await fn(); }
  catch(e){ console.error(e); toast(e.message || 'ç™¼ç”ŸéŒ¯èª¤', false); throw e; }
  finally{ if(target) setBusy(target,false); }
}
const debounce = (fn, ms=400) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); }; };
function fmtTWDateTime(iso){ if(!iso) return ''; try { return new Date(iso).toLocaleString('zh-TW', {hour12:false}); } catch { return iso; } }

/* -------------------- Domain helpers -------------------- */
function fhirName(p) {
  const n = (p.name && p.name[0]) || {};
  const fam = n.family || "";
  const giv = (n.given || []).join(" ");
  return (fam + " " + giv).trim() || "(no name)";
}

let selectedPatient = null;
let selectedObservation = null;
let obsPage = 1;

function enablePatientActions(enable) { el("btn-update-p").disabled = !enable; el("btn-delete-p").disabled = !enable; }
function enableObsActions(enable) { el("btn-update-o").disabled = !enable; el("btn-delete-o").disabled = !enable; }
function fillPatientForm(p) {
  const n = (p.name && p.name[0]) || {};
  el("p-family").value = n.family || "";
  el("p-given").value  = (n.given && n.given[0]) || "";
  el("p-gender").value = p.gender || "";
  el("p-birth").value  = p.birthDate || "";
}

/* -------------------- Render Patients / Observations -------------------- */
function renderPatients(bundle) {
  const rows = (bundle.entry || []).map(e => e.resource);
  const tb = el("patients").querySelector("tbody");
  tb.innerHTML = "";
  const subjectSelect = el("o-subject");
  subjectSelect.innerHTML = "";

  for (const p of rows) {
    const tr = document.createElement("tr");
    tr.style.cursor = "pointer";
    tr.setAttribute('tabindex', '0');
    tr.addEventListener("click", () => {
      tb.querySelectorAll("tr").forEach(r => r.classList.remove("row-selected"));
      tr.classList.add("row-selected");
      selectedPatient = p; enablePatientActions(true); fillPatientForm(p); loadObservations(1);
    });
    tr.addEventListener("keydown", (e) => { if (e.key === 'Enter' || e.key === ' ') tr.click(); });
    tr.innerHTML = `
      <td>${fhirName(p)}</td>
      <td>${p.gender || ""}</td>
      <td>${p.birthDate || ""}</td>
      <td class="id">${p.id}</td>
      <td class="right"><button class="secondary" aria-label="é¸å– ${fhirName(p)}">é¸å–</button></td>
    `;
    tb.appendChild(tr);
    const opt = new Option(`${fhirName(p)} (${p.id})`, `Patient/${p.id}`);
    subjectSelect.add(opt);
  }
  if (rows.length === 0) {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 5; td.className = 'empty'; td.textContent = 'ç›®å‰æ²’æœ‰è³‡æ–™';
    tr.appendChild(td); tb.appendChild(tr);
  }
}

function renderObservations(bundle) {
  const rows = (bundle.entry || []).map(e => e.resource);
  const tb = el("obstable").querySelector("tbody");
  tb.innerHTML = "";
  selectedObservation = null; enableObsActions(false);

  rows.forEach(o => {
    const code = (o.code && (o.code.text || (o.code.coding && o.code.coding[0]?.display))) || "";
    const val  = o.valueQuantity ? `${o.valueQuantity.value ?? ""} ${o.valueQuantity.unit ?? ""}` : "";
    const eff  = o.effectiveDateTime || "";
    const tr = document.createElement("tr");
    tr.style.cursor = "pointer";
    tr.setAttribute('tabindex', '0');
    tr.addEventListener("click", () => {
      tb.querySelectorAll("tr").forEach(r => r.classList.remove("row-selected"));
      tr.classList.add("row-selected");
      selectedObservation = o; enableObsActions(true);
      el("o-subject").value = `Patient/${selectedPatient.id}`;
      el("o-status").value  = o.status;
      el("o-code").value    = code;
      el("o-time").value    = eff ? new Date(eff).toISOString().slice(0,16) : "";
      el("o-value").value   = o.valueQuantity?.value ?? "";
      el("o-unit").value    = o.valueQuantity?.unit ?? "";
    });
    tr.addEventListener("keydown", (e) => { if (e.key === 'Enter' || e.key === ' ') tr.click(); });
    tr.innerHTML = `
      <td>${o.status}</td>
      <td>${code}</td>
      <td>${val}</td>
      <td>${fmtTWDateTime(eff)}</td>
      <td class="id">${o.id}</td>
    `;
    tb.appendChild(tr);
  });
  if (rows.length === 0) {
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 5; td.className = 'empty';
    td.textContent = selectedPatient ? 'ç›®å‰æ²’æœ‰ Observation' : 'å°šæœªé¸æ“‡ç—…äºº';
    tr.appendChild(td); tb.appendChild(tr);
  }
}

/* -------------------- Results /api/list-runs -------------------- */
function isImg(url){ return /\.(png|jpg|jpeg|gif)$/i.test(url); }
function isSheet(url){ return /\.(xlsx|csv)$/i.test(url); }
function baseName(url){ try { return decodeURIComponent(url.split('/').pop()); } catch { return url; } }
function iconFor(url){
  if (isImg(url)) return 'ğŸ–¼ï¸';
  if (isSheet(url)) return 'ğŸ“Š';
  if (/\.json$/i.test(url)) return 'ğŸ§©';
  if (/\.zip$/i.test(url)) return 'ğŸ“¦';
  return 'ğŸ“„';
}

function renderRuns(runs){
  const sel = el('runs-select');
  sel.innerHTML = '';
  if(!runs || runs.length===0){
    el('files').innerHTML = '<div class="empty">ç›®å‰æ²’æœ‰ä»»ä½• Run</div>';
    el('runs-count').textContent = '0 æª”';
    return;
  }
  runs.forEach(r => sel.add(new Option(r.run_id, r.run_id)));
  sel.value = runs[runs.length-1].run_id;

  const show = (runId)=>{
    const run = runs.find(r => r.run_id === runId) || runs[runs.length-1];
    const files = run.files || [];
    el('runs-count').textContent = `${files.length} æª”`;

    const wrap = el('files'); wrap.innerHTML = '';
    if(files.length===0){ wrap.innerHTML = '<div class="empty">æ­¤ Run å…§æ²’æœ‰æª”æ¡ˆ</div>'; return; }

    files.forEach(url=>{
      const item = document.createElement('div');
      item.className = 'file';

      const thumb = document.createElement('div');
      thumb.className = 'thumb';
      if (isImg(url)) {
        const img = new Image();
        img.src = url; img.alt = baseName(url); img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; img.style.borderRadius='10px';
        img.addEventListener('click', ()=>openPreview(url));
        thumb.appendChild(img);
      } else {
        thumb.textContent = iconFor(url);
      }

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `<div class="name" title="${baseName(url)}">${baseName(url)}</div>
                        <div class="path" title="${url}">${url}</div>`;

      const acts = document.createElement('div');
      acts.className = 'actions';
      const aOpen = document.createElement('a');
      aOpen.href = url; aOpen.target = '_blank';
      aOpen.textContent = 'é–‹å•Ÿ / ä¸‹è¼‰';
      const btnCopy = document.createElement('button');
      btnCopy.type='button'; btnCopy.textContent='è¤‡è£½é€£çµ';
      btnCopy.addEventListener('click', async()=>{ await navigator.clipboard.writeText(location.origin + url); toast('å·²è¤‡è£½'); });

      acts.appendChild(aOpen); acts.appendChild(btnCopy);
      item.appendChild(thumb); item.appendChild(meta); item.appendChild(acts);
      wrap.appendChild(item);
    });
  };

  sel.onchange = e => show(e.target.value);
  show(sel.value);
}

async function loadRuns(targetBtn){
  await safe(async ()=>{
    const data = await api.get('/api/list-runs');
    if(!data.ok){ throw new Error('API not ok'); }
    renderRuns(data.runs || []);
  }, {target: targetBtn});
}

/* å½±åƒé è¦½ Overlay */
function openPreview(src){
  const ov = el('overlay'); const img = el('overlay-img');
  img.src = src; ov.classList.add('show'); ov.setAttribute('aria-hidden','false');
}
['overlay','overlay-img'].forEach(id=>{
  el(id).addEventListener('click', ()=>{ el('overlay').classList.remove('show'); el('overlay').setAttribute('aria-hidden','true'); });
});

/* -------------------- Data flows -------------------- */
async function loadPatients(q = "") {
  const url = q ? `/Patient?name=${encodeURIComponent(q)}` : "/Patient";
  const bundle = await api.get(url);
  renderPatients(bundle);
  setJSON("last-json", bundle);
}
async function loadObservations(page = obsPage) {
  if (!selectedPatient) { el("sel-name").textContent = "æœªé¸æ“‡"; el("sel-id").textContent = ""; return; }
  obsPage = page;
  el("sel-name").textContent = fhirName(selectedPatient);
  el("sel-id").textContent   = `Patient/${selectedPatient.id}`;
  const sort = el("o-sort").value;
  const count = parseInt(el("o-count").value, 10) || 10;
  el("o-page").textContent = String(obsPage);
  const url = `/Observation?subject=${encodeURIComponent("Patient/" + selectedPatient.id)}&_page=${obsPage}&_count=${count}&_sort=${encodeURIComponent(sort)}`;
  const bundle = await api.get(url);
  renderObservations(bundle);
  setJSON("last-json", bundle);
}

/* -------------------- ç¶å®š -------------------- */
el("btn-create-p").addEventListener("click", createPatient);
el("btn-update-p").addEventListener("click", updatePatient);
el("btn-delete-p").addEventListener("click", deletePatient);
el("btn-refresh").addEventListener("click", () => loadPatients());
el("btn-search-p").addEventListener("click", () => loadPatients(el("q-name").value || ""));
const debouncedSearch = debounce(()=> loadPatients(el("q-name").value || ""), 400);
el("q-name").addEventListener("input", debouncedSearch);

el("btn-create-o").addEventListener("click", createObservation);
el("btn-update-o").addEventListener("click", updateObservation);
el("btn-delete-o").addEventListener("click", deleteObservation);

el("o-prev").addEventListener("click", () => { if (obsPage > 1) loadObservations(obsPage - 1); });
el("o-next").addEventListener("click", () => loadObservations(obsPage + 1));
el("o-sort").addEventListener("change", () => loadObservations(1));
el("o-count").addEventListener("change", () => loadObservations(1));

el('runs-refresh').addEventListener('click', (e)=> loadRuns(e.target));

/* -------------------- åˆå§‹ -------------------- */
loadPatients().catch(err => { console.error(err); toast('è¼‰å…¥ Patients å¤±æ•—', false); });
loadRuns().catch(err => { console.error(err); toast('è¼‰å…¥ Results å¤±æ•—', false); });

/* -------------------- CRUD å¯¦ä½œ -------------------- */
async function createPatient() {
  await safe(async ()=> {
    const body = {
      resourceType: "Patient",
      name: [{ family: el("p-family").value || undefined, given: [el("p-given").value].filter(Boolean) }],
      gender: el("p-gender").value || undefined,
      birthDate: el("p-birth").value || undefined
    };
    const res = await api.post("/Patient", body);
    setJSON("p-result", res);
    toast('å·²å»ºç«‹ Patient');
    await loadPatients();
  }, {target: el("btn-create-p")});
}
async function updatePatient() {
  if (!selectedPatient) return;
  await safe(async ()=> {
    const id = selectedPatient.id;
    const body = {
      resourceType: "Patient",
      id,
      name: [{ family: el("p-family").value || undefined, given: [el("p-given").value].filter(Boolean) }],
      gender: el("p-gender").value || undefined,
      birthDate: el("p-birth").value || undefined
    };
    const res = await api.put(`/Patient/${id}`, body);
    setJSON("p-result", res);
    toast('å·²æ›´æ–° Patient');
    await loadPatients();
  }, {target: el("btn-update-p")});
}
async function deletePatient() {
  if (!selectedPatient) return;
  if (!confirm(`ç¢ºèªåˆªé™¤ç—…äºº ${fhirName(selectedPatient)}ï¼ˆ${selectedPatient.id}ï¼‰ï¼Ÿ`)) return;
  await safe(async ()=> { await api.del(`/Patient/${selectedPatient.id}`); }, {target: el("btn-delete-p")});
  selectedPatient = null; enablePatientActions(false);
  toast('å·²åˆªé™¤ Patient');
  await loadPatients();
  el("sel-name").textContent = "æœªé¸æ“‡"; el("sel-id").textContent = ""; renderObservations({entry:[]});
}
async function createObservation() {
  await safe(async ()=> {
    const nowISO = new Date().toISOString();
    const chosen = el("o-time").value ? new Date(el("o-time").value).toISOString() : nowISO;
    const body = {
      resourceType: "Observation",
      status: el("o-status").value,
      code: { text: el("o-code").value || "Body Measure" },
      subject: { reference: el("o-subject").value },
      effectiveDateTime: chosen,
      valueQuantity: {
        value: el("o-value").value ? Number(el("o-value").value) : undefined,
        unit: el("o-unit").value || undefined
      }
    };
    const res = await api.post("/Observation", body);
    setJSON("o-result", res);
    toast('å·²å»ºç«‹ Observation');
    if (selectedPatient && body.subject.reference.endsWith(selectedPatient.id)) await loadObservations(1);
  }, {target: el("btn-create-o")});
}
async function updateObservation() {
  if (!selectedObservation) return;
  await safe(async ()=> {
    const id = selectedObservation.id;
    const body = {
      resourceType: "Observation",
      id,
      status: el("o-status").value,
      code: { text: el("o-code").value || "Body Measure" },
      subject: { reference: el("o-subject").value },
      effectiveDateTime: el("o-time").value ? new Date(el("o-time").value).toISOString() : undefined,
      valueQuantity: {
        value: el("o-value").value ? Number(el("o-value").value) : undefined,
        unit: el("o-unit").value || undefined
      }
    };
    const res = await api.put(`/Observation/${id}`, body);
    setJSON("o-result", res);
    toast('å·²æ›´æ–° Observation');
    await loadObservations();
  }, {target: el("btn-update-o")});
}
async function deleteObservation() {
  if (!selectedObservation) return;
  if (!confirm(`ç¢ºèªåˆªé™¤ Observation ${selectedObservation.id}ï¼Ÿ`)) return;
  await safe(async ()=> { await api.del(`/Observation/${selectedObservation.id}`); }, {target: el("btn-delete-o")});
  selectedObservation = null; enableObsActions(false);
  toast('å·²åˆªé™¤ Observation');
  await loadObservations();
}
</script>
</body>
</html>
